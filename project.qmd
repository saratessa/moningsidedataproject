---
title: "project"
format: html
editor: visual
---

## Multilevel Modeling

```{r}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(janitor) 
library(readxl)
library(dplyr)
library(lme4)
library(lmerTest)
library(dplyr)
library(ggplot2)
library(ggeffects)

df_all <- read.csv("df_all.csv")
```

## Model 1: Total Sample

```{r}
m1 <- lmer(
  raw_growth ~ factor(program_year) * domain_type + start_grade_diff_c + measure + (1 | id),
  data = df_all %>% filter (domain_type != "other", time == 2)
)

summary(m1)

#model above is general growth by program year, domain type, initial skill moderation, and measure



```

## Interpretation Notes m1

students in 2nd year had .18 units more growth on average, p \<.016, effect is small

no difference in 1st vs 2nd year by domain

students who started higher grew substantially less (this is full sample so includes areas that weren't targeted), so this makes sense, also really high variability across areas

high variability within students (makes sense considering targeted/untargeted areas) residual variance 3.24

## Model 1 Visual

```{r}
pred <- ggpredict(m1, terms = c("program_year", "domain_type"))

# Plot with points and error bars instead of ribbon
ggplot(pred, aes(x = x, y = predicted, color = group)) +
  geom_point(size = 3) +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high), width = 0.1) +
  scale_x_continuous(breaks = c(1, 2), labels = c("Year 1", "Year 2")) +
  labs(
    title = "Predicted Raw Growth by Program Year and Domain Type",
    x = "Program Year",
    y = "Predicted Raw Growth (Spring − Fall)",
    color = "Domain"
  ) +
  theme_minimal(base_size = 14)
```

## Model 2: Only Scores Below Grade Level at Start Point

```{r}
m2 <- df_all %>%
  filter(
    start_grade_diff < 0,          # actually below grade level
    domain_type != "other",
    time == 2                      # growth rows
  ) %>%
  lmer(
    raw_growth ~ factor(program_year) * domain_type +
      start_grade_diff_c +
      measure +
      (1 | id),
    data = .
  )


summary(m2)
```

## Interpretation Notes M2

when considering only areas below grade level at start, 2nd year has an additional .23 units of growth, p = .008

domain type- lower growth in math -0.41, p = .009

shift to more variance between students .97 vs. .71 preiously, lower within student variance (makes sense, above grade level measures removed (2.49)

## Model 2 Visual

```{r}

# plot
library(ggeffects)
library(ggplot2)

pred <- ggpredict(m2, terms = "program_year")

ggplot(pred, aes(x = x, y = predicted)) +
  geom_line() +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high), alpha = .2) +
  labs(
    title = "Predicted Scores by Program Year",
    x = "Program Year (1 = Year 1, 2 = Year 2)",
    y = "Predicted Score"
  ) +
  theme_minimal()


#OR

pred <- ggpredict(m2, terms = c("program_year", "domain_type"))

# Plot predicted scores
ggplot(pred, aes(x = x, y = predicted, color = group)) +
  geom_line(size = 1) +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high, fill = group), alpha = 0.2, color = NA) +
  scale_x_continuous(breaks = c(1, 2), labels = c("Year 1", "Year 2")) +
  labs(
    title = "Predicted Scores by Program Year and Domain Type",
    x = "Program Year",
    y = "Predicted Score",
    color = "Domain",
    fill = "Domain"
  ) +
  theme_minimal(base_size = 14)


#OR

pred <- ggpredict(m2, terms = c("program_year", "domain_type"))

# Plot with points and error bars instead of ribbon
ggplot(pred, aes(x = x, y = predicted, color = group)) +
  geom_point(size = 3) +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high), width = 0.1) +
  scale_x_continuous(breaks = c(1, 2), labels = c("Year 1", "Year 2")) +
  labs(
    title = "Predicted Raw Growth by Program Year and Domain Type",
    x = "Program Year",
    y = "Predicted Raw Growth (Spring − Fall)",
    color = "Domain"
  ) +
  theme_minimal(base_size = 14)

```

## Model 3: Includes time_c to observe changes in growth rate over time (still working on this)

```{r}
m3 <- lmer(
  raw_growth ~ time_c * factor(program_year) + start_grade_diff_c + domain_type + measure + (1 | id),
  data = df_all %>% filter(domain_type != "other")
)

summary(m3)
```

## Model 3 Visual

```{r}
pred <- ggpredict(m3, terms = c("program_year", "domain_type"))

# Plot with points and error bars instead of ribbon
ggplot(pred, aes(x = x, y = predicted, color = group)) +
  geom_point(size = 3) +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high), width = 0.1) +
  scale_x_continuous(breaks = c(1, 2), labels = c("Year 1", "Year 2")) +
  labs(
    title = "Predicted Raw Growth by Program Year and Domain Type",
    x = "Program Year",
    y = "Predicted Raw Growth (Spring − Fall)",
    color = "Domain"
  ) +
  theme_minimal(base_size = 14)
```

## Model 4: does growth accelerate? filtered by below at start point

```{r}
m4 <- df_all %>%
  filter(
    start_grade_diff < 0,      # below grade level
    domain_type != "other"
  ) %>%
  lmer(
    score ~ time_c * factor(program_year) * domain_type +
      start_grade_diff_c +
      measure +
      (time_c | id),
    data = .
  )

summary(m4)
```

## Model 4 Visual (this isn't right) 

```{r}
pred <- ggpredict(m4, terms = c("program_year", "domain_type"))

# Plot with points and error bars instead of ribbon
ggplot(pred, aes(x = x, y = predicted, color = group)) +
  geom_point(size = 3) +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high), width = 0.1) +
  scale_x_continuous(breaks = c(1, 2), labels = c("Year 1", "Year 2")) +
  labs(
    title = "Predicted Raw Growth by Program Year and Domain Type",
    x = "Program Year",
    y = "Predicted Raw Growth (Spring − Fall)",
    color = "Domain"
  ) +
  theme_minimal(base_size = 14)

```

##  Model 5: interaction with acceleration/domain? idk

```{r}
m5 <- df_all %>%
  filter(
    start_grade_diff < 0,       # only students who start below grade level
    domain_type != "other"      # keep literacy + math only
  ) %>%
  lmer(
    raw_growth ~ time_c * factor(program_year) * domain_type +
      start_grade_diff_c +
      measure +
      (time_c | id),
    data = .
  )

summary(m5)
```

\
**Do Year 2 students grow faster?**

-   Year 2 students have a **significantly steeper growth slope** than Year 1 students.

    Effect size = **+0.19** over the time scale you’re using. Statistically significant (p = .023).

**Interaction: Time × Domain (–0.15, p = .038)**

Math grows more slowly than literacy. Math growth slope is **0.15 points per unit time smaller** than literacy.

```{r}
pred <- ggpredict(m5, terms = c("time_c [all]", "program_year", "domain_type"))

ggplot(pred, aes(x = time_c, y = predicted, color = factor(program_year))) +
  geom_line(size = 1) +
  geom_ribbon(
    aes(ymin = conf.low, ymax = conf.high, fill = factor(program_year)),
    alpha = 0.2,
    color = NA
  ) +
  scale_color_manual(values = c("darkblue", "darkred")) +
  scale_fill_manual(values = c("lightblue", "pink")) +
  labs(
    title = "Predicted Growth Over Time (Below Grade Level Students Only)",
    x = "Time (centered)",
    y = "Predicted Score",
    color = "Program Year",
    fill = "Program Year"
  ) +
  facet_wrap(~ domain_type, scales = "free_y") +
  theme_minimal(base_size = 14)
```
