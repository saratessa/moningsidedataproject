---
title: "project"
format: html
editor: visual
---

```{r}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(janitor) 
library(readxl)
library(dplyr)
library(lme4)
library(lmerTest)
```

Multilevel Modeling

```{r}
the gr
```

```{r}

df_growth <- df_all %>%
  filter(domain_type != "other") %>%          # ← EXCLUDE "other"
  arrange(id, program_year, measure, time) %>%
  group_by(id, measure, domain_type, program_year) %>%
  summarise(
    growth = diff(score),                     # spring – fall gain
    start_grade_diff = first(grade_diff),     # how far behind/ahead they started
    .groups = "drop"
  )

df_growth$program_year_f <- factor(df_growth$program_year, levels = c(1, 2))

```

Multilevel Modeling

```{r}
# 3. Three-level multilevel model
# Outcome: score
# Predictors: time, grade_diff, domain_type
# Random effects: student intercept + slope, program year intercept
# -----------------------------


df_use <- df_all %>%
  filter(domain_type != "other", time == 2)    # only spring rows carry the real gain

model_prog_year <- lmer(
  raw_growth ~ factor(program_year) * domain_type + 
    measure + grade_diff + (1 | id),
  data = df_use
)

summary(model_prog_year)

```

\

```{r}
m1 <- lmer(
  raw_growth ~ factor(program_year) * grade_diff + (1 | id),
  data = df_use
)

summary(m1)

```

```{r}
library(ggeffects)
library(ggplot2)

# Get predicted means from the long-format model
preds <- ggpredict(
  model_prog_year,
  terms = c("program_year", "domain_type")   # <- use original variable name
)

# Plot predicted raw gains
ggplot(preds, aes(x = x, y = predicted, color = group)) +
  geom_point(size = 3) +
  geom_line(aes(group = group), size = 1) +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high), width = 0.1) +
  scale_x_continuous(
    breaks = c(1, 2),
    labels = c("Year 1", "Year 2")
  ) +
  scale_y_continuous(
    limits = c(1, 2.5),
    breaks = seq(1, 2.5, by = 0.25)
  ) +
  theme_minimal(base_size = 14) +
  labs(
    x = "Program Year",
    y = "Predicted Raw Growth (Spring − Fall)",
    color = "Domain",
    title = "Predicted Raw Growth by Program Year and Domain Type"
  )
```

```{r}
summary(df_all)
```

Model Without Domain Breakdown:

```{r}
df_use_overall <- df_all %>%
  filter(domain_type != "other", time == 2)

# Linear mixed model: raw growth ~ program year + measure + starting grade_diff
model_prog_year_overall <- lmer(
  raw_growth ~ factor(program_year) + 
    measure + grade_diff + (1 | id),
  data = df_use_overall
)

summary(model_prog_year_overall)
```

```{r}
library(ggeffects)
library(ggplot2)

# Get predicted means for program year only
preds_overall <- ggpredict(
  model_prog_year_overall,
  terms = "program_year"
)

# Plot
ggplot(preds_overall, aes(x = x, y = predicted)) +
  geom_point(size = 3, color = "steelblue") +
  geom_line(aes(group = 1), size = 1, color = "steelblue") +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high), width = 0.1, color = "steelblue") +
  scale_x_continuous(
    breaks = c(1, 2),
    labels = c("Year 1", "Year 2")
  ) +
  scale_y_continuous(
    limits = c(1.5, 2.5),
    breaks = seq(1.5, 2.5, by = 0.25)
  ) +
  theme_minimal(base_size = 14) +
  labs(
    x = "Program Year",
    y = "Predicted Raw Growth (Spring − Fall)",
    title = "Predicted Overall Raw Growth by Program Year"
  )
```
