---
title: "project"
format: html
editor: visual
---

## Multilevel Modeling

Load packages

```{r}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(janitor) 
library(readxl)
library(dplyr)
library(lme4)
library(lmerTest)
library(dplyr)
library(ggplot2)
library(ggeffects)

df_all <- read.csv("df_all.csv")
```

## M1 (ALL measures that are below at timepoint 1)

```{r}
m1 <- df_all %>%
  group_by(id, measure) %>%
  filter(any(time_cont == 1 & grade_diff < 0)) %>%  # all measures where the ID was below 0 at time 1 for that measure type
  ungroup() %>%
  filter(
    domain_type != "other", 
    domain_type != "composite",
    time == 2    # growth rows only
  ) %>%
  lmer(
    raw_growth ~ factor(program_year) * domain_type +
      start_grade_diff_c +
      measure +
      (1 + program_year| id),
    data = .
  )

summary(m1)
```

### Visualization

```{r}
pred <- ggpredict(m1, terms = "program_year")

ggplot(pred, aes(x = x, y = predicted)) +
  geom_line() +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high), alpha = .2) +
  labs(
    title = "Predicted Scores by Program Year",
    x = "Program Year (1 = Year 1, 2 = Year 2)",
    y = "Predicted Score"
  ) +
  theme_minimal()


#OR

pred <- ggpredict(m1, terms = c("program_year", "domain_type"))

# Plot predicted scores
ggplot(pred, aes(x = x, y = predicted, color = group)) +
  geom_line(size = 1) +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high, fill = group), alpha = 0.2, color = NA) +
  scale_x_continuous(breaks = c(1, 2), labels = c("Year 1", "Year 2")) +
  labs(
    title = "Predicted Scores by Program Year and Domain Type",
    x = "Program Year",
    y = "Predicted Score",
    color = "Domain",
    fill = "Domain"
  ) +
  theme_minimal(base_size = 14)


#OR

pred <- ggpredict(m1, terms = c("program_year", "domain_type"))

# Plot with points and error bars instead of ribbon
ggplot(pred, aes(x = x, y = predicted, color = group)) +
  geom_point(size = 3) +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high), width = 0.1) +
  scale_x_continuous(breaks = c(1, 2), labels = c("Year 1", "Year 2")) +
  labs(
    title = "Predicted Raw Growth by Program Year and Domain Type",
    x = "Program Year",
    y = "Predicted Raw Growth (Spring − Fall)",
    color = "Domain"
  ) +
  theme_minimal(base_size = 14)




# 1️⃣ Keep only students and measures in the filtered dataset
df_below_measures <- df_all %>%
  group_by(id, measure) %>%
  filter(any(time_cont == 1 & grade_diff < 0)) %>%  # measures below grade at T1
  ungroup() %>%
  filter(domain_type != "other", time == 2)          # growth rows

# 2️⃣ Generate predicted values for program_year x domain_type
preds <- ggpredict(m1, terms = c("program_year", "domain_type"))
pred_df <- as.data.frame(preds)

# 3️⃣ Plot
ggplot() +
  # Individual student trajectories (gray)
  geom_line(data = df_below_measures,
            aes(x = program_year, y = raw_growth, group = id),
            color = "grey70", alpha = 0.3) +
  # Predicted mean trajectories by domain (colored lines)
  geom_line(data = pred_df,
            aes(x = x, y = predicted, color = group),
            size = 1.2) +
  # Confidence intervals for predicted means
  geom_ribbon(data = pred_df,
              aes(x = x, ymin = conf.low, ymax = conf.high, fill = group),
              alpha = 0.2, color = NA) +
  scale_x_continuous(breaks = 1:2, labels = c("Year 1", "Year 2")) +
  labs(
    x = "Program Year",
    y = "Raw Growth",
    color = "Domain Type",
    fill = "Domain Type",
    title = "Raw Growth Trajectories for Students Below Grade at T1",
    subtitle = "Individual trajectories (gray) and predicted mean ± 95% CI (colored)"
  ) +
  theme_minimal()
```

## M2 (LOWEST measure at timepoint 1)

```{r}
datamin$measure <- as.factor(datamin$measure)
datamin$measure <- fct_relevel(datamin$measure,"mf")

m2 <- lm(raw_growth ~ measure + start_grade_diff_c + program_year, data = datamin)
summary(m2)

```

### Visualization

```{r}
pred <- ggpredict(m2, terms = "program_year")

ggplot(pred, aes(x = x, y = predicted)) +
  geom_line() +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high), alpha = .2) +
  labs(
    title = "Predicted Scores by Program Year",
    x = "Program Year (1 = Year 1, 2 = Year 2)",
    y = "Predicted Score"
  ) +
  theme_minimal()


#OR

pred <- ggpredict(m1, terms = c("program_year", "domain_type"))

# Plot predicted scores
ggplot(pred, aes(x = x, y = predicted, color = group)) +
  geom_line(size = 1) +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high, fill = group), alpha = 0.2, color = NA) +
  scale_x_continuous(breaks = c(1, 2), labels = c("Year 1", "Year 2")) +
  labs(
    title = "Predicted Scores by Program Year and Domain Type",
    x = "Program Year",
    y = "Predicted Score",
    color = "Domain",
    fill = "Domain"
  ) +
  theme_minimal(base_size = 14)





```

```{r}
library(emmeans)
library(ggplot2)

emm_meas <- emmeans(
  m2, 
  ~ measure,
  at = list(start_grade_diff_c = 0)  # average starting level
)

emm_df <- as.data.frame(emm_meas)

ggplot(emm_df, aes(x = reorder(measure, emmean), y = emmean)) +
  geom_point(size = 2) +
  geom_errorbar(
    aes(ymin = emmean - SE, ymax = emmean + SE),
    width = 0.2
  ) +
  coord_flip() +
  labs(
    x = "Lowest Starting Measure",
    y = "Adjusted Mean Raw Growth",
    title = "Adjusted Raw Growth by Lowest Starting Measure",
    subtitle = "Adjusted for starting grade difference and program year"
  ) +
  theme_minimal()
```

------------------------------------------------------------------------

## Total Sample Model (Not using)

```{r}
m1 <- df_all
  
  lmer(
  grade_diff ~ factor(program_year) * domain_type + start_grade_diff_c + measure + (1 | id),
  data = df_all %>% filter (domain_type != "other", time == 2)
)

summary(m1)

#model above is general growth by program year, domain type, initial skill moderation, and measure



```

## Total Sample Model Visual (Not using)

```{r}
pred <- ggpredict(m1, terms = c("program_year", "domain_type"))

# Plot with points and error bars instead of ribbon
ggplot(pred, aes(x = x, y = predicted, color = group)) +
  geom_point(size = 3) +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high), width = 0.1) +
  scale_x_continuous(breaks = c(1, 2), labels = c("Year 1", "Year 2")) +
  labs(
    title = "Predicted Raw Growth by Program Year and Domain Type",
    x = "Program Year",
    y = "Predicted Raw Growth (Spring − Fall)",
    color = "Domain"
  ) +
  theme_minimal(base_size = 14)
```

## Model 2: Only Scores Below Grade Level at Start Point

```{r}

```

## Interpretation Notes M2

when considering only areas below grade level at start, 2nd year has an additional .23 units of growth, p = .008

domain type- lower growth in math -0.41, p = .009

shift to more variance between students .97 vs. .71 preiously, lower within student variance (makes sense, above grade level measures removed (2.49)

## Model 2 Visual

```{r}

# plot
library(ggeffects)
library(ggplot2)

pred <- ggpredict(m2, terms = "program_year")

ggplot(pred, aes(x = x, y = predicted)) +
  geom_line() +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high), alpha = .2) +
  labs(
    title = "Predicted Scores by Program Year",
    x = "Program Year (1 = Year 1, 2 = Year 2)",
    y = "Predicted Score"
  ) +
  theme_minimal()


#OR

pred <- ggpredict(m2, terms = c("program_year", "domain_type"))

# Plot predicted scores
ggplot(pred, aes(x = x, y = predicted, color = group)) +
  geom_line(size = 1) +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high, fill = group), alpha = 0.2, color = NA) +
  scale_x_continuous(breaks = c(1, 2), labels = c("Year 1", "Year 2")) +
  labs(
    title = "Predicted Scores by Program Year and Domain Type",
    x = "Program Year",
    y = "Predicted Score",
    color = "Domain",
    fill = "Domain"
  ) +
  theme_minimal(base_size = 14)


#OR

pred <- ggpredict(m2, terms = c("program_year", "domain_type"))

# Plot with points and error bars instead of ribbon
ggplot(pred, aes(x = x, y = predicted, color = group)) +
  geom_point(size = 3) +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high), width = 0.1) +
  scale_x_continuous(breaks = c(1, 2), labels = c("Year 1", "Year 2")) +
  labs(
    title = "Predicted Raw Growth by Program Year and Domain Type",
    x = "Program Year",
    y = "Predicted Raw Growth (Spring − Fall)",
    color = "Domain"
  ) +
  theme_minimal(base_size = 14)

```

## Model 3: Includes time_c to observe changes in growth rate over time (still working on this)

```{r}
m3 <- lmer(
  raw_growth ~ time_c * factor(program_year) + start_grade_diff_c + domain_type + measure + (1 | id),
  data = df_all %>% filter(domain_type != "other")
)

summary(m3)
```

## Model 3 Visual

```{r}
pred <- ggpredict(m3, terms = c("program_year", "domain_type"))

# Plot with points and error bars instead of ribbon
ggplot(pred, aes(x = x, y = predicted, color = group)) +
  geom_point(size = 3) +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high), width = 0.1) +
  scale_x_continuous(breaks = c(1, 2), labels = c("Year 1", "Year 2")) +
  labs(
    title = "Predicted Raw Growth by Program Year and Domain Type",
    x = "Program Year",
    y = "Predicted Raw Growth (Spring − Fall)",
    color = "Domain"
  ) +
  theme_minimal(base_size = 14)
```

## Model 4: does growth accelerate? filtered by below at start point

```{r}
m4 <- df_all %>%
  filter(
    start_grade_diff < 0,      # below grade level
    domain_type != "other"
  ) %>%
  lmer(
    score ~ time_c * factor(program_year) * domain_type +
      start_grade_diff_c +
      measure +
      (time_c | id),
    data = .
  )

summary(m4)
```

## Model 4 Visual (this isn't right)

```{r}
pred <- ggpredict(m4, terms = c("program_year", "domain_type"))

# Plot with points and error bars instead of ribbon
ggplot(pred, aes(x = x, y = predicted, color = group)) +
  geom_point(size = 3) +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high), width = 0.1) +
  scale_x_continuous(breaks = c(1, 2), labels = c("Year 1", "Year 2")) +
  labs(
    title = "Predicted Raw Growth by Program Year and Domain Type",
    x = "Program Year",
    y = "Predicted Raw Growth (Spring − Fall)",
    color = "Domain"
  ) +
  theme_minimal(base_size = 14)

```

## Model 5: interaction with acceleration/domain? idk

```{r}
m5 <- df_all %>%
  filter(
    start_grade_diff < 0,       # only students who start below grade level
    domain_type != "other"      # keep literacy + math only
  ) %>%
  lmer(
    raw_growth ~ time_c * factor(program_year) * domain_type +
      start_grade_diff_c +
      measure +
      (time_c | id),
    data = .
  )

summary(m5)
```

\
**Do Year 2 students grow faster?**

-   Year 2 students have a **significantly steeper growth slope** than Year 1 students.

    Effect size = **+0.19** over the time scale you’re using. Statistically significant (p = .023).

**Interaction: Time × Domain (–0.15, p = .038)**

Math grows more slowly than literacy. Math growth slope is **0.15 points per unit time smaller** than literacy.

```{r}
pred <- ggpredict(m5, terms = c("time_c [all]", "program_year", "domain_type"))

ggplot(pred, aes(x = time_c, y = predicted, color = factor(program_year))) +
  geom_line(size = 1) +
  geom_ribbon(
    aes(ymin = conf.low, ymax = conf.high, fill = factor(program_year)),
    alpha = 0.2,
    color = NA
  ) +
  scale_color_manual(values = c("darkblue", "darkred")) +
  scale_fill_manual(values = c("lightblue", "pink")) +
  labs(
    title = "Predicted Growth Over Time (Below Grade Level Students Only)",
    x = "Time (centered)",
    y = "Predicted Score",
    color = "Program Year",
    fill = "Program Year"
  ) +
  facet_wrap(~ domain_type, scales = "free_y") +
  theme_minimal(base_size = 14)
```
