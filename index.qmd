---
title: "index"
format: html
editor: visual
---

## Tidying Deidentified Data

Load Packages

```{r}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(janitor) 
library(readxl)
library(dplyr)
library(lme4)
library(lmerTest)
```

## Deidentifying 2008-2009 and 2009-2010

```{r}
df_2008 <- read_excel("G:/My Drive/3. Research/Morningside Data Project/identified data files/2008-2009 pre-post.xlsx") %>%
  clean_names() %>%
  mutate(year_start = 2008)

#Switching wide to long, renaming spring/fall to time 1 and 2

df_2008<- df_2008 %>%
  pivot_longer(
    cols = c(starts_with("FALL"), starts_with("SPRING")),
    names_to = c("Season", "Measure"),
    names_sep = "_",
    values_to = "Score"
  ) %>%
  mutate(
    Season = str_to_lower(Season),
    Time = case_when(
      Season == "fall" ~ 1,
      Season == "spring" ~ 2,
      TRUE ~ NA_real_
    )
  ) %>%
  select(-Season) 

#Bringing in year 2

df_2009 <- read_excel("G:/My Drive/3. Research/Morningside Data Project/identified data files/2009-2010 pre_post.xlsx") %>%
  clean_names() %>%
  mutate(year_start = 2009)

#Switching wide to long, renaming spring/fall to time 1 and 2

df_2009<- df_2009 %>%
  pivot_longer(
    cols = c(starts_with("FALL"), starts_with("SPRING")),
    names_to = c("Season", "Measure"),
    names_sep = "_",
    values_to = "Score"
  ) %>%
  mutate(
    Season = str_to_lower(Season),
    Time = case_when(
      Season == "fall" ~ 1,
      Season == "spring" ~ 2,
      TRUE ~ NA_real_
    )
  ) %>%
  select(-Season) 

#At this point the data has name, grade, year_start (e.g., school year starts in 2008, measure, score, and time (e.g., measurement 1 or 2))

#Binding year 1 and year 2 into the same frame

cohort1 <- bind_rows(df_2008, df_2009)

#Group by student and assign ID number

cohort1 <- cohort1 %>%
  group_by(name) %>%
  mutate(
    id = paste0(name, "0810") #for 2008-2010 cohort id
  ) %>%
  ungroup() %>%
  select(-name) %>%
  relocate(id)

write_csv(cohort1, "cohort1.csv")
rm(df_2008, df_2009, cohort1)
```

## Deidentifying 2015-2016 and 2016-2017

```{r}
df_2015 <- read_excel("G:/My Drive/3. Research/Morningside Data Project/identified data files/2015-2016 pre-post.xlsx") %>%
  clean_names() %>%
  mutate(year_start = 2015)

#Switching wide to long, renaming spring/fall to time 1 and 2

df_2015<- df_2015 %>%
  pivot_longer(
    cols = c(starts_with("FALL"), starts_with("SPRING")),
    names_to = c("Season", "Measure"),
    names_sep = "_",
    values_to = "Score"
  ) %>%
  mutate(
    Score = as.numeric(Score),
    Season = str_to_lower(Season),
    Time = case_when(
      Season == "fall" ~ 1,
      Season == "spring" ~ 2,
      TRUE ~ NA_real_
    )
  ) %>%
  select(-Season) 

#Bringing in year 2

df_2016 <- read_excel("G:/My Drive/3. Research/Morningside Data Project/identified data files/2016-2017 pre-post.xlsx") %>%
  clean_names() %>%
  mutate(year_start = 2016)

#Switching wide to long, renaming spring/fall to time 1 and 2

df_2016<- df_2016 %>%
  mutate(across(matches("^(fall|spring)"), ~as.numeric(.))) %>% 
  pivot_longer(
    cols = c(starts_with("FALL"), starts_with("SPRING")),
    names_to = c("Season", "Measure"),
    names_sep = "_",
    values_to = "Score"
  ) %>%
  mutate(
    Score = as.numeric(Score),
    Season = str_to_lower(Season),
    Time = case_when(
      Season == "fall" ~ 1,
      Season == "spring" ~ 2,
      TRUE ~ NA_real_
    )
  ) %>%
  select(-Season) 

#Binding year 1 and year 2 into the same frame

cohort2 <- bind_rows(df_2015, df_2016)

cohort2 <- cohort2 %>%
  group_by(name) %>%
  mutate(
    id = paste0(name, "1517") #for 2008-2010 cohort id
  ) %>%
  ungroup() %>%
  select(-name) %>%
  relocate(id)

write_csv(cohort2, "cohort2.csv")
rm(df_2015, df_2016, cohort2)
```

## Deidentifying 2023-2024 and 2024-2025

```{r}
#Bringing in year 1

df_2023 <- read_excel("G:/My Drive/3. Research/Morningside Data Project/identified data files/2023-2024 pre_post.xlsx") %>%
  clean_names() %>%
  mutate(year_start = 2023)

#Switching wide to long, renaming spring/fall to time 1 and 2

df_2023<- df_2023 %>%
  pivot_longer(
    cols = c(starts_with("FALL"), starts_with("SPRING")),
    names_to = c("Season", "Measure"),
    names_sep = "_",
    values_to = "Score"
  ) %>%
  mutate(
    Score = as.numeric(Score),
    Season = str_to_lower(Season),
    Time = case_when(
      Season == "fall" ~ 1,
      Season == "spring" ~ 2,
      TRUE ~ NA_real_
    )
  ) %>%
  select(-Season) 


#Bringing in year 2

df_2024 <- read_excel("G:/My Drive/3. Research/Morningside Data Project/identified data files/2024-2025 pre-post.xlsx") %>%
  clean_names() %>%
  mutate(year_start = 2024)

#Switching wide to long, renaming spring/fall to time 1 and 2

df_2024<- df_2024 %>%
  mutate(across(matches("^(fall|spring)"), ~as.numeric(.))) %>% 
  pivot_longer(
    cols = c(starts_with("FALL"), starts_with("SPRING")),
    names_to = c("Season", "Measure"),
    names_sep = "_",
    values_to = "Score"
  ) %>%
  mutate(
    Score = as.numeric(Score),
    Season = str_to_lower(Season),
    Time = case_when(
      Season == "fall" ~ 1,
      Season == "spring" ~ 2,
      TRUE ~ NA_real_
    )
  ) %>%
  select(-Season) 


#Binding year 1 and year 2 into the same frame
df_2023 <- df_2023 %>%
  mutate(
    grade = as.numeric(grade)
  )

cohort3 <- bind_rows(df_2023, df_2024)


cohort3 <- cohort3 %>%
  group_by(name) %>%
  mutate(
    id = paste0(name, "2325") #for 2008-2010 cohort id
  ) %>%
  ungroup() %>%
  select(-name) %>%
  relocate(id)

write_csv(cohort3, "cohort3.csv")
rm(df_2023, df_2024, cohort3)
```

## Start Here for Code Changes: Combines De-Identified CSVs

```{r}
df1 <- read.csv("cohort1.csv")
df2 <- read.csv("cohort2.csv")
df3 <- read.csv("cohort3.csv")
df_all <- bind_rows(df1, df2, df3)

```

## Cleaning, Manipulating, Centering Variables for Analysis

```{r}

colnames(df_all)
names(df_all)<- c("id", "grade", "cal_year", "measure", "score", "time")
df_all <- df_all %>%
  mutate(
    id = as.factor(id),
    cal_year = as.numeric(cal_year),
    grade = as.numeric(grade),
    time = as.numeric(time),     # 1 = fall, 2 = spring
    measure = as.factor(measure),
    score = as.numeric(score)
  )


df_all <- df_all %>%
  group_by(id) %>%
  mutate(
    # find the student's earliest year
    first_year = min(cal_year, na.rm = TRUE),
    # calculate how many years since the student's first year
    program_year = cal_year - first_year + 1
  ) %>%
    select(-first_year)

  #   select(-first_year)


#adding a column for a continuous time variable (e.g., 1,2,3,4 time points)
df_all <- df_all %>%
  arrange(id, cal_year, time) %>%  # make sure data is sorted correctly
  group_by(id) %>%
  mutate(
    time_cont = (cal_year - min(cal_year)) * 2 + time
    # Explanation:
    # min(cal_year) = first year for the student
    # *2 because there are 2 time points per year (fall, spring)
    # + time to get either 1 or 2 within that year
  ) %>%
  ungroup()

#student_year identifier
df_all <- df_all %>%
  mutate(student_year = paste(id, cal_year, sep = "_"))

#adding a column indicating literacy or math

df_all <- df_all %>%
  mutate(
    domain_type = case_when(
      measure %in% c("rc", "lang", "cap", "punc", "ue", "lwid", "wa", "rf", "wf", "ws") ~ "literacy",
      measure %in% c("ce", "psdi", "comp", "mf", "maths", "calc") ~ "math",
      TRUE ~ "other"
    )
  )

#adding a column with difference from score to actual grade level

df_all <- df_all %>%
  mutate(
    grade_diff = score - grade
  )

df_all <- df_all %>%
  group_by(id, program_year, measure) %>%
  mutate(
    start_grade_diff = grade_diff[time == 1]   # fall = time 1
  ) %>%
  ungroup()

#adding raw growth score on each measure

df_all <- df_all %>%
  group_by(id, cal_year, measure) %>%
  arrange(time) %>%
  mutate(
    fall_score   = first(score),
    spring_score = last(score),
    raw_growth   = spring_score - fall_score
  ) %>%
  ungroup()


#adding columns for centered variables 

df_all <- df_all%>%
  mutate(
    start_grade_diff_c = as.numeric(scale(start_grade_diff, scale = FALSE)),  # center without scaling
    time_c = time_cont - mean(time_cont, na.rm = TRUE)                          # center continuous time
  ) %>%
  ungroup()

view(df_all)
```

## Rewriting Full Dataset of All Variables

```{r}
write.csv(df_all, "df_all.csv", row.names = FALSE)

df_all <- read.csv("df_all.csv")
```

## Data Dictionary

| Column Name | Data Type | Description / Notes |
|------------------------|------------------------|------------------------|
| `id` | Factor / Character | Unique identifier for each student. Created to de-identify names. |
| `grade` | Numeric | Student's current grade level at the time of the assessment. |
| `cal_year` | Numeric | Calendar year of the assessment (e.g., 2008, 2009). |
| `measure` | Factor | Specific assessment/skill measured (e.g., `rc`, `lwid`, `wa`). |
| `score` | Numeric | Raw score or grade-equivalent score for the measure. |
| `time` | Numeric | Timepoint within the school year: 1 = Fall, 2 = Spring. |
| `program_year` | Numeric | Year in the program for the student (1 = first year, 2 = second year, etc.). |
| `student_year` | Character | Unique identifier for each student Ã— year (e.g., `10810_2008`). |
| `domain_type` | Factor | Categorizes measures as `literacy`, `math`, or `other`. |
| `grade_diff` | Numeric | Difference between the student's score and their actual grade level (`score - grade`). |
| `fall_score` | Numeric | Score at Fall timepoint for that measure. |
| `spring_score` | Numeric | Score at Spring timepoint for that measure. |
| `raw_growth` | Numeric | Change in score from Fall to Spring (`spring_score - fall_score`). |
| `grade_diff_c` | Numeric | Centered version of `grade_diff` (grand-mean centered). |
| `time_cont` | Numeric | Continuous time variable across multiple years (e.g., 1, 2, 3, 4 for sequential semesters). |
| `time_c` | Numeric | Centered continuous time variable for modeling growth trajectories. |
